# 2.1.2 - Luồng Đăng Nhập

## Thông tin chung
- **Mã tính năng:** 2.1.2
- **Actor:** Mọi người
- **Yêu cầu:** Có tài khoản đã đăng ký (2.1.1)
- **Mục đích:** Xác thực người dùng và cấp quyền truy cập hệ thống

## Flowchart

```mermaid
flowchart TD
    Start([Bắt đầu]) --> A[Người dùng truy cập<br/>trang Đăng nhập]
    A --> B[Hiển thị form đăng nhập]
    B --> C[Nhập Email và Mật khẩu]
    C --> D[Click "Đăng nhập"]
    D --> E{Validate dữ liệu<br/>phía Client}
    
    E -->|Email không hợp lệ| F[Hiển thị lỗi:<br/>"Email không đúng định dạng"]
    E -->|Mật khẩu trống<br/>hoặc < 8 hoặc > 16 ký tự| G[Hiển thị lỗi:<br/>"Mật khẩu không hợp lệ"]
    
    F --> C
    G --> C
    
    E -->|Hợp lệ| H[Gửi request đến Server]
    H --> I{Kiểm tra Email<br/>trong database}
    
    I -->|Không tìm thấy| J[Hiển thị lỗi:<br/>"Email hoặc mật khẩu<br/>không chính xác"]
    J --> C
    
    I -->|Tìm thấy| K{Kiểm tra<br/>trạng thái tài khoản}
    
    K -->|Chờ xác nhận| L[Hiển thị lỗi:<br/>"Tài khoản chưa được<br/>xác nhận"]
    K -->|Vô hiệu hóa| M[Hiển thị lỗi:<br/>"Tài khoản đã bị<br/>vô hiệu hóa"]
    
    L --> C
    M --> C
    
    K -->|Đã kích hoạt| N{So sánh<br/>mật khẩu hash}
    
    N -->|Không khớp| J
    
    N -->|Khớp| O[Tạo JWT Token<br/>Thời hạn: 24 giờ]
    O --> P[Lưu token vào<br/>localStorage/Cookie]
    P --> Q{Kiểm tra vai trò<br/>người dùng}
    
    Q -->|Reader| R[Chuyển đến<br/>Dashboard Độc giả]
    Q -->|Librarian| S[Chuyển đến<br/>Dashboard Nhân viên]
    Q -->|Admin| T[Chuyển đến<br/>Dashboard Quản lý]
    
    R --> End([Kết thúc])
    S --> End
    T --> End
```

## Validation Rules

| Trường | Quy tắc | Thông báo lỗi |
|--------|---------|---------------|
| Email | Định dạng email hợp lệ | "Email không đúng định dạng" |
| Email | Tồn tại trong hệ thống | "Email hoặc mật khẩu không chính xác" |
| Mật khẩu | Không được trống | "Mật khẩu không được để trống" |
| Mật khẩu | 8-16 ký tự | "Mật khẩu phải từ 8-16 ký tự" |
| Mật khẩu | Khớp với hash trong DB | "Email hoặc mật khẩu không chính xác" |

## Trạng thái tài khoản

| Trạng thái | Cho phép đăng nhập | Thông báo |
|------------|-------------------|-----------|
| Chờ xác nhận | ❌ | "Tài khoản chưa được xác nhận" |
| Đã kích hoạt | ✅ | - |
| Vô hiệu hóa | ❌ | "Tài khoản đã bị vô hiệu hóa" |

## JWT Token Structure

```json
{
  "userId": "uuid",
  "email": "user@example.com",
  "name": "Tên người dùng",
  "role": "Reader|Librarian|Admin",
  "iat": 1234567890,
  "exp": 1234654290
}
```

## Redirect sau đăng nhập

| Vai trò | Dashboard |
|---------|-----------|
| Reader | `/reader/dashboard` |
| Librarian | `/librarian/dashboard` |
| Admin | `/admin/dashboard` |

## Ghi chú
- Token có thời hạn 24 giờ
- Sau khi hết hạn, người dùng cần đăng nhập lại
- Không hiển thị cụ thể lỗi "Email không tồn tại" hay "Mật khẩu sai" để bảo mật

