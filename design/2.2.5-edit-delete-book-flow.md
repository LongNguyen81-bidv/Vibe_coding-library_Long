# 2.2.5 - Luồng Sửa & Xóa Sách

## Thông tin chung
- **Mã tính năng:** 2.2.5
- **Actor:** Nhân viên thư viện (Librarian)
- **Yêu cầu:** 
  - Đăng nhập với vai trò Nhân viên thư viện (2.1.2)
  - Có sách trong hệ thống (2.2.4)
- **Mục đích:** Chỉnh sửa thông tin sách hoặc xóa sách khỏi hệ thống

## Flowchart - Sửa thông tin sách

```mermaid
flowchart TD
    Start([Bắt đầu]) --> A[Nhân viên xem<br/>Chi tiết sách]
    A --> B[Click nút "Sửa"]
    B --> C[Hiển thị form<br/>chỉnh sửa với dữ liệu<br/>hiện tại]
    
    C --> D[Chỉnh sửa thông tin:<br/>- Tên sách<br/>- Tác giả<br/>- Năm xuất bản<br/>- ISBN<br/>- Thể loại<br/>- Mô tả<br/>- Số lượng]
    
    D --> E[Click "Lưu"]
    E --> F{Validate dữ liệu}
    
    F -->|Tên sách không hợp lệ| G[Hiển thị lỗi tên]
    F -->|Tác giả không hợp lệ| H[Hiển thị lỗi tác giả]
    F -->|Năm XB không hợp lệ| I[Hiển thị lỗi năm]
    F -->|ISBN không hợp lệ| J[Hiển thị lỗi ISBN]
    F -->|Thể loại chưa chọn| K[Hiển thị lỗi thể loại]
    F -->|Mô tả không hợp lệ| L[Hiển thị lỗi mô tả]
    F -->|Số lượng không hợp lệ| M[Hiển thị lỗi số lượng]
    
    G --> D
    H --> D
    I --> D
    J --> D
    K --> D
    L --> D
    M --> D
    
    F -->|Hợp lệ| N{ISBN đã được sách<br/>khác sử dụng?}
    
    N -->|Đã tồn tại| O[Hiển thị lỗi:<br/>"ISBN đã được sử dụng"]
    O --> D
    
    N -->|Chưa tồn tại<br/>hoặc ISBN cũ| P{Số lượng mới <<br/>Số đang mượn?}
    
    P -->|Có| Q[Hiển thị lỗi:<br/>"Số lượng không thể nhỏ hơn<br/>số sách đang mượn"]
    Q --> D
    
    P -->|Không| R[Cập nhật database]
    R --> S[Hiển thị thông báo:<br/>"Cập nhật sách thành công!"]
    S --> T[Quay lại trang<br/>Chi tiết sách]
    T --> End([Kết thúc])
```

## Flowchart - Xóa sách

```mermaid
flowchart TD
    Start([Bắt đầu]) --> A[Nhân viên xem<br/>Chi tiết sách]
    A --> B[Click nút "Xóa"]
    B --> C{Kiểm tra có đơn<br/>mượn đang hoạt động?}
    
    C -->|Có đơn đang mượn<br/>hoặc chờ xác nhận| D[Hiển thị lỗi:<br/>"Không thể xóa sách<br/>đang có đơn mượn hoạt động"]
    D --> End([Kết thúc])
    
    C -->|Không có| E[Hiển thị modal xác nhận:<br/>"Bạn có chắc chắn<br/>muốn xóa sách này?<br/>Hành động không thể hoàn tác."]
    
    E --> F{Người dùng<br/>xác nhận?}
    
    F -->|Hủy| G[Đóng modal<br/>Quay lại Chi tiết sách]
    G --> End
    
    F -->|Xác nhận xóa| H[Xóa sách khỏi database<br/>Xóa các dữ liệu liên quan:<br/>- Lịch sử mượn đã trả]
    H --> I[Hiển thị thông báo:<br/>"Xóa sách thành công!"]
    I --> J[Chuyển đến<br/>Danh sách sách]
    J --> End
```

## Validation Rules - Sửa sách

| Trường | Quy tắc | Thông báo lỗi |
|--------|---------|---------------|
| Tên sách | Không được trống | "Tên sách không được để trống" |
| Tên sách | Tối đa 100 ký tự | "Tên sách không được vượt quá 100 ký tự" |
| Tác giả | Không được trống | "Tác giả không được để trống" |
| Tác giả | Tối đa 100 ký tự | "Tác giả không được vượt quá 100 ký tự" |
| Năm xuất bản | >= 1900 và <= năm hiện tại | "Năm xuất bản không hợp lệ" |
| ISBN | Định dạng ISBN-10/13 | "ISBN không đúng định dạng" |
| ISBN | Unique (trừ ISBN cũ) | "ISBN đã được sử dụng" |
| Thể loại | Phải chọn | "Vui lòng chọn thể loại" |
| Mô tả | Không được trống | "Mô tả không được để trống" |
| Mô tả | Tối đa 255 ký tự | "Mô tả không được vượt quá 255 ký tự" |
| Số lượng | > 0 | "Số lượng phải lớn hơn 0" |
| Số lượng | >= Số đang mượn | "Số lượng không thể nhỏ hơn số sách đang mượn" |

## Điều kiện xóa sách

| Điều kiện | Cho phép xóa | Thông báo |
|-----------|--------------|-----------|
| Không có đơn mượn hoạt động | ✅ | - |
| Có đơn mượn "Đang mượn" | ❌ | "Không thể xóa sách đang có đơn mượn hoạt động" |
| Có đơn mượn "Chờ xác nhận" | ❌ | "Không thể xóa sách đang có đơn mượn hoạt động" |
| Chỉ có đơn "Đã trả" | ✅ | - |

## Cập nhật số lượng sách

Khi sửa số lượng sách, hệ thống tự động tính:

```
availableQuantity = totalQuantity - borrowedQuantity
```

| Trường hợp | Kết quả |
|------------|---------|
| Tăng số lượng | availableQuantity tăng |
| Giảm số lượng (>= borrowedQuantity) | availableQuantity giảm |
| Giảm số lượng (< borrowedQuantity) | ❌ Không cho phép |

## Ghi chú
- Chỉ Nhân viên thư viện mới có quyền sửa/xóa sách
- Không thể xóa sách đang được mượn để đảm bảo tính toàn vẹn dữ liệu
- Khi xóa sách, lịch sử mượn đã trả cũng bị xóa
- Cần xác nhận 2 bước khi xóa để tránh xóa nhầm

