# 2.3.1 - Luồng Mượn Sách (Độc Giả)

## Thông tin chung
- **Mã tính năng:** 2.3.1
- **Actor:** Độc giả (Reader)
- **Yêu cầu:** 
  - Đăng nhập với vai trò Độc giả (2.1.2)
  - Có sách trong hệ thống (2.2.4)
- **Mục đích:** Cho phép độc giả tạo yêu cầu mượn sách

## Flowchart - Mượn sách

```mermaid
flowchart TD
    Start([Bắt đầu]) --> A[Độc giả đăng nhập]
    A --> B[Xem Chi tiết sách<br/>2.2.4]
    B --> C[Click "Mượn Sách"]
    C --> D{Kiểm tra điều kiện<br/>mượn sách}
    
    D --> E{Sách còn<br/>có sẵn?}
    E -->|Không<br/>availableQuantity = 0| F[Hiển thị lỗi:<br/>"Sách đã hết,<br/>vui lòng quay lại sau"]
    F --> End([Kết thúc])
    
    E -->|Có| G{Độc giả đã mượn<br/>>= 5 cuốn?}
    G -->|Có| H[Hiển thị lỗi:<br/>"Bạn đã đạt giới hạn<br/>mượn tối đa 5 cuốn"]
    H --> End
    
    G -->|Không| I{Độc giả có<br/>khoản phạt chưa<br/>thanh toán?}
    I -->|Có| J[Hiển thị lỗi:<br/>"Bạn có khoản phạt<br/>chưa thanh toán.<br/>Vui lòng thanh toán<br/>trước khi mượn sách."]
    J --> End
    
    I -->|Không| K[Hiển thị modal<br/>chọn thời hạn mượn]
    K --> L[Chọn thời hạn:<br/>Mặc định 14 ngày<br/>Tối đa 30 ngày]
    L --> M[Click "Xác nhận mượn"]
    M --> N[Tạo đơn mượn:<br/>- Trạng thái: "Chờ xác nhận"<br/>- Ngày mượn: Hôm nay<br/>- Ngày hết hạn: Ngày mượn + Thời hạn]
    
    N --> O[Hiển thị thông báo:<br/>"Yêu cầu mượn sách<br/>đã được gửi!<br/>Vui lòng chờ nhân viên<br/>xác nhận."]
    O --> P[Chuyển đến trang<br/>Lịch sử mượn sách]
    P --> End
```

## Điều kiện mượn sách

| STT | Điều kiện | Kiểm tra | Thông báo lỗi |
|-----|-----------|----------|---------------|
| 1 | Sách còn có sẵn | availableQuantity > 0 | "Sách đã hết, vui lòng quay lại sau" |
| 2 | Chưa vượt giới hạn | borrowingCount < 5 | "Bạn đã đạt giới hạn mượn tối đa 5 cuốn" |
| 3 | Không có nợ phạt | unpaidFines = 0 | "Bạn có khoản phạt chưa thanh toán" |

## Thời hạn mượn sách

| Tùy chọn | Giá trị |
|----------|---------|
| Mặc định | 14 ngày |
| Tối thiểu | 7 ngày |
| Tối đa | 30 ngày |

## Trạng thái đơn mượn

| Trạng thái | Mô tả |
|------------|-------|
| Chờ xác nhận | Độc giả đã tạo yêu cầu, chờ nhân viên xác nhận |
| Đang mượn | Nhân viên đã xác nhận, sách đã được giao |
| Quá hạn | Đã quá ngày hết hạn nhưng chưa trả |
| Đã trả | Sách đã được trả |
| Bị từ chối | Nhân viên từ chối yêu cầu mượn |

## Dữ liệu đơn mượn

```json
{
  "id": "uuid",
  "readerId": "uuid",
  "bookId": "uuid",
  "borrowDate": "2024-01-01",
  "dueDate": "2024-01-15",
  "status": "PENDING",
  "createdAt": "2024-01-01T10:00:00Z"
}
```

## Quy tắc nghiệp vụ

1. **Giới hạn mượn:** Mỗi độc giả chỉ được mượn tối đa 5 cuốn sách cùng lúc
2. **Nợ phạt:** Không được mượn sách nếu có khoản phạt chưa thanh toán
3. **Thời hạn:** Có thể chọn từ 7-30 ngày, mặc định 14 ngày
4. **Trạng thái ban đầu:** Đơn mượn luôn bắt đầu với trạng thái "Chờ xác nhận"

## Ghi chú
- Sau khi tạo yêu cầu, độc giả cần đợi nhân viên xác nhận
- Độc giả cần đến thư viện để nhận sách vật lý
- Số lượng sách có sẵn chưa bị trừ ở bước này (chỉ trừ khi nhân viên xác nhận)

