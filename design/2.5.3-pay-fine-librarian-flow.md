# 2.5.3 - Luồng Xem & Xác Nhận Thanh Toán Phạt (Nhân Viên)

## Thông tin chung
- **Mã tính năng:** 2.5.3
- **Actor:** Nhân viên thư viện (Librarian)
- **Yêu cầu:** 
  - Đăng nhập với vai trò Nhân viên thư viện (2.1.2)
  - Có phiếu phạt chờ xác nhận thanh toán (2.5.2)
- **Mục đích:** Xác nhận hoặc từ chối thanh toán khoản phạt từ độc giả

## Flowchart - Tổng quan

```mermaid
flowchart TD
    Start([Bắt đầu]) --> A[Nhân viên đăng nhập]
    A --> B[Truy cập menu<br/>"Quản lý khoản phạt"]
    B --> C[Hiển thị danh sách<br/>phiếu phạt]
    
    C --> D{Có tab nào<br/>được chọn?}
    
    D -->|Tất cả| E[Hiển thị tất cả<br/>phiếu phạt]
    D -->|Chờ xác nhận| F[Hiển thị phiếu phạt<br/>chờ xác nhận TT]
    D -->|Chưa thanh toán| G[Hiển thị phiếu phạt<br/>chưa thanh toán]
    D -->|Đã thanh toán| H[Hiển thị phiếu phạt<br/>đã thanh toán]
    
    E --> I{Nhân viên muốn<br/>làm gì?}
    F --> I
    G --> I
    H --> I
    
    I -->|Xem chi tiết| J[Hiển thị chi tiết<br/>phiếu phạt]
    I -->|Xác nhận TT| K[Luồng Xác nhận<br/>thanh toán]
    I -->|Từ chối TT| L[Luồng Từ chối<br/>thanh toán]
    I -->|Không làm gì| End([Kết thúc])
    
    J --> I
    K --> C
    L --> C
```

## Flowchart - Xác nhận thanh toán

```mermaid
flowchart TD
    Start([Xác nhận TT]) --> A{Phiếu phạt<br/>ở trạng thái<br/>"Chờ xác nhận"?}
    
    A -->|Không| B[Không hiển thị<br/>nút xác nhận]
    B --> End([Kết thúc])
    
    A -->|Có| C[Click "Xác nhận<br/>thanh toán"]
    C --> D[Hiển thị modal:<br/>- Thông tin phiếu phạt<br/>- Số tiền<br/>- Bằng chứng thanh toán<br/>  ảnh chứng từ/mã GD]
    
    D --> E[Nhân viên kiểm tra<br/>bằng chứng thanh toán]
    E --> F{Thanh toán<br/>hợp lệ?}
    
    F -->|Có| G[Click "Xác nhận"]
    G --> H[Cập nhật database:<br/>- status = "PAID"<br/>- confirmedAt = Hôm nay<br/>- confirmedBy = ID NV]
    H --> I[Hiển thị thông báo:<br/>"Xác nhận thanh toán<br/>thành công!"]
    I --> End
    
    F -->|Không| J[Chuyển sang<br/>Luồng Từ chối]
    J --> End
```

## Flowchart - Từ chối thanh toán

```mermaid
flowchart TD
    Start([Từ chối TT]) --> A{Phiếu phạt<br/>ở trạng thái<br/>"Chờ xác nhận"?}
    
    A -->|Không| B[Không hiển thị<br/>nút từ chối]
    B --> End([Kết thúc])
    
    A -->|Có| C[Click "Từ chối"]
    C --> D[Hiển thị modal<br/>nhập lý do từ chối]
    D --> E[Nhập lý do từ chối]
    E --> F[Click "Xác nhận từ chối"]
    F --> G{Lý do có<br/>được nhập?}
    
    G -->|Không/Trống| H[Hiển thị lỗi:<br/>"Vui lòng nhập<br/>lý do từ chối"]
    H --> E
    
    G -->|Có| I[Cập nhật database:<br/>- status = "REJECTED"<br/>- rejectionReason = lý do<br/>- rejectedAt = Hôm nay<br/>- rejectedBy = ID NV]
    I --> J[Hiển thị thông báo:<br/>"Đã từ chối<br/>thanh toán"]
    J --> End([Kết thúc])
```

## Thông tin hiển thị trong danh sách

| Trường | Mô tả |
|--------|-------|
| Mã phiếu | ID phiếu phạt |
| Tên độc giả | Người bị phạt |
| Email | Email độc giả |
| Tên sách | Sách liên quan |
| Nguyên nhân | Trả muộn / Hư hỏng / Mất |
| Số tiền | Số tiền phạt (VNĐ) |
| Ngày phạt | Ngày tạo phiếu |
| Trạng thái | Chưa TT / Chờ XN / Từ chối / Đã TT |
| Hành động | Xem / Xác nhận / Từ chối |

## Thông tin chi tiết phiếu phạt

| Trường | Mô tả |
|--------|-------|
| Mã phiếu | ID phiếu phạt |
| Thông tin độc giả | Tên, Email, SĐT |
| Thông tin sách | Tên sách, ISBN |
| Thông tin mượn | Ngày mượn, Hạn trả, Ngày trả |
| Nguyên nhân phạt | Chi tiết lý do bị phạt |
| Mức phạt | Tên mức phạt áp dụng |
| Số tiền | Số tiền phải trả |
| Bằng chứng TT | Ảnh chứng từ / Mã giao dịch |
| Ghi chú | Ghi chú của nhân viên khi tạo phạt |

## Validation Rules

| Trường | Quy tắc | Thông báo lỗi |
|--------|---------|---------------|
| Lý do từ chối | Bắt buộc khi từ chối | "Vui lòng nhập lý do từ chối" |
| Lý do từ chối | Tối đa 500 ký tự | "Lý do không được vượt quá 500 ký tự" |

## Lý do từ chối phổ biến

- Số tiền chuyển khoản không đúng
- Nội dung chuyển khoản không chính xác
- Không tìm thấy giao dịch trong hệ thống
- Ảnh chứng từ không rõ ràng
- Mã giao dịch không hợp lệ

## Cập nhật dữ liệu

### Khi xác nhận thanh toán

| Trường | Giá trị |
|--------|---------|
| status | "PAID" |
| confirmedAt | Thời điểm xác nhận |
| confirmedBy | ID nhân viên |

### Khi từ chối thanh toán

| Trường | Giá trị |
|--------|---------|
| status | "REJECTED" |
| rejectionReason | Lý do từ chối |
| rejectedAt | Thời điểm từ chối |
| rejectedBy | ID nhân viên |

## Bộ lọc

| Bộ lọc | Mô tả |
|--------|-------|
| Tất cả | Hiển thị tất cả phiếu phạt |
| Chờ xác nhận | Phiếu đang chờ xác nhận TT |
| Chưa thanh toán | Phiếu chưa được thanh toán |
| Đã thanh toán | Phiếu đã được xác nhận TT |
| Từ chối | Phiếu bị từ chối TT |

## Ghi chú
- Nhân viên cần kiểm tra kỹ bằng chứng thanh toán trước khi xác nhận
- Khi bị từ chối, độc giả sẽ thấy lý do và có thể thanh toán lại
- Sau khi xác nhận thanh toán, độc giả có thể mượn sách mới
- Lịch sử xác nhận/từ chối được lưu để theo dõi

