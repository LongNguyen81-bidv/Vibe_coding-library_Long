# 2.3.2 - Luồng Mượn Sách (Nhân Viên Thư Viện)

## Thông tin chung
- **Mã tính năng:** 2.3.2
- **Actor:** Nhân viên thư viện (Librarian)
- **Yêu cầu:** 
  - Đăng nhập với vai trò Nhân viên thư viện (2.1.2)
  - Có đơn mượn chờ xác nhận (2.3.1)
- **Mục đích:** Xác nhận hoặc từ chối các yêu cầu mượn sách từ độc giả

## Flowchart - Tổng quan

```mermaid
flowchart TD
    Start([Bắt đầu]) --> A[Nhân viên đăng nhập]
    A --> B[Truy cập menu<br/>"Quản lý mượn trả"]
    B --> C[Tab "Chờ xác nhận mượn"]
    C --> D[Hiển thị danh sách<br/>đơn mượn chờ xác nhận]
    
    D --> E{Có đơn mượn<br/>chờ xác nhận?}
    E -->|Không| F[Hiển thị:<br/>"Không có yêu cầu<br/>mượn sách nào"]
    F --> End([Kết thúc])
    
    E -->|Có| G[Chọn đơn mượn<br/>cần xử lý]
    G --> H{Nhân viên<br/>chọn hành động}
    
    H -->|Xác nhận| I[Luồng Xác nhận<br/>mượn sách]
    H -->|Từ chối| J[Luồng Từ chối<br/>mượn sách]
    
    I --> D
    J --> D
```

## Flowchart - Xác nhận mượn sách

```mermaid
flowchart TD
    Start([Xác nhận mượn]) --> A[Click "Xác nhận"<br/>trên đơn mượn]
    A --> B{Kiểm tra sách<br/>còn có sẵn?}
    
    B -->|Không<br/>availableQuantity = 0| C[Hiển thị lỗi:<br/>"Sách đã hết,<br/>không thể xác nhận"]
    C --> End([Kết thúc])
    
    B -->|Có| D[Hiển thị modal xác nhận:<br/>"Xác nhận giao sách<br/>cho độc giả?"]
    D --> E{Người dùng<br/>xác nhận?}
    
    E -->|Hủy| End
    
    E -->|Xác nhận| F[Cập nhật database:<br/>- Đơn mượn: "Đang mượn"<br/>- Sách: availableQuantity - 1<br/>- Sách: borrowedQuantity + 1]
    
    F --> G[Hiển thị thông báo:<br/>"Xác nhận mượn sách<br/>thành công!"]
    G --> End
```

## Flowchart - Từ chối mượn sách

```mermaid
flowchart TD
    Start([Từ chối mượn]) --> A[Click "Từ chối"<br/>trên đơn mượn]
    A --> B[Hiển thị modal<br/>nhập lý do từ chối]
    B --> C[Nhập lý do từ chối]
    C --> D[Click "Xác nhận từ chối"]
    D --> E{Lý do có<br/>được nhập?}
    
    E -->|Không/Trống| F[Hiển thị lỗi:<br/>"Vui lòng nhập<br/>lý do từ chối"]
    F --> C
    
    E -->|Có| G[Cập nhật database:<br/>- Đơn mượn: "Bị từ chối"<br/>- Lưu lý do từ chối]
    G --> H[Hiển thị thông báo:<br/>"Đã từ chối yêu cầu<br/>mượn sách"]
    H --> End([Kết thúc])
```

## Thông tin hiển thị trong danh sách

| Trường | Mô tả |
|--------|-------|
| Mã đơn | ID đơn mượn |
| Tên độc giả | Tên người yêu cầu mượn |
| Email độc giả | Email liên hệ |
| Tên sách | Sách được yêu cầu mượn |
| Ngày yêu cầu | Ngày tạo đơn mượn |
| Thời hạn mượn | Số ngày muốn mượn |
| Hành động | Nút Xác nhận / Từ chối |

## Validation Rules

| Trường | Quy tắc | Thông báo lỗi |
|--------|---------|---------------|
| Lý do từ chối | Bắt buộc khi từ chối | "Vui lòng nhập lý do từ chối" |
| Lý do từ chối | Tối đa 500 ký tự | "Lý do không được vượt quá 500 ký tự" |

## Cập nhật dữ liệu khi xác nhận

| Đối tượng | Trường | Thay đổi |
|-----------|--------|----------|
| Đơn mượn | status | "PENDING" → "BORROWED" |
| Đơn mượn | confirmedAt | = Thời điểm xác nhận |
| Đơn mượn | confirmedBy | = ID nhân viên |
| Sách | availableQuantity | -1 |
| Sách | borrowedQuantity | +1 |

## Cập nhật dữ liệu khi từ chối

| Đối tượng | Trường | Thay đổi |
|-----------|--------|----------|
| Đơn mượn | status | "PENDING" → "REJECTED" |
| Đơn mượn | rejectedAt | = Thời điểm từ chối |
| Đơn mượn | rejectedBy | = ID nhân viên |
| Đơn mượn | rejectionReason | = Lý do từ chối |

## Lý do từ chối phổ biến

- Sách đã hết trong kho
- Thông tin độc giả không hợp lệ
- Độc giả có lịch sử vi phạm
- Sách đang được bảo trì/sửa chữa
- Khác (tùy nhập)

## Ghi chú
- Nhân viên phải nhập lý do khi từ chối để độc giả biết nguyên nhân
- Số lượng sách chỉ thay đổi khi xác nhận, không thay đổi khi từ chối
- Độc giả có thể xem lý do từ chối trong Lịch sử mượn sách (2.3.3)

