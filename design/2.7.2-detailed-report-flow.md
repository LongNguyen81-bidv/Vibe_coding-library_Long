# 2.7.2 - Luồng Báo Cáo Chi Tiết

## Thông tin chung
- **Mã tính năng:** 2.7.2
- **Actor:** Quản lý viên (Admin), Nhân viên thư viện (Librarian)
- **Yêu cầu:** 
  - Đăng nhập với vai trò Admin hoặc Librarian (2.1.2)
  - Có Dashboard và dữ liệu đầy đủ (2.7.1)
- **Mục đích:** Xem báo cáo chi tiết và xuất dữ liệu ra file

## Flowchart - Tổng quan

```mermaid
flowchart TD
    Start([Bắt đầu]) --> A[Admin/Librarian<br/>đăng nhập]
    A --> B[Truy cập menu<br/>"Báo cáo"]
    B --> C[Hiển thị trang<br/>Báo cáo chi tiết]
    C --> D[Chọn loại báo cáo]
    
    D --> E{Loại báo cáo?}
    
    E -->|Báo cáo Sách| F[Luồng Báo cáo Sách]
    E -->|Báo cáo Mượn Trả| G[Luồng Báo cáo<br/>Mượn Trả]
    E -->|Báo cáo Phạt| H[Luồng Báo cáo Phạt]
    E -->|Báo cáo Sách Mất/Hư| I[Luồng Báo cáo<br/>Sách Mất/Hư]
    
    F --> J{Muốn xuất báo cáo?}
    G --> J
    H --> J
    I --> J
    
    J -->|Có| K[Luồng Xuất CSV]
    J -->|Không| End([Kết thúc])
    
    K --> End
```

## Flowchart - Lọc theo thời gian

```mermaid
flowchart TD
    Start([Lọc thời gian]) --> A[Hiển thị dropdown<br/>"Khoảng thời gian"]
    A --> B[Chọn khoảng thời gian]
    B --> C{Loại khoảng<br/>thời gian?}
    
    C -->|Hôm nay| D[startDate = today<br/>endDate = today]
    C -->|Tuần này| E[startDate = đầu tuần<br/>endDate = today]
    C -->|Tháng này| F[startDate = đầu tháng<br/>endDate = today]
    C -->|Quý này| G[startDate = đầu quý<br/>endDate = today]
    C -->|Năm này| H[startDate = đầu năm<br/>endDate = today]
    C -->|Tùy chỉnh| I[Hiển thị date picker<br/>chọn startDate và endDate]
    
    D --> J[Gọi API với<br/>startDate và endDate]
    E --> J
    F --> J
    G --> J
    H --> J
    I --> J
    
    J --> K[Hiển thị báo cáo<br/>theo khoảng thời gian]
    K --> End([Kết thúc])
```

## Flowchart - Báo cáo Sách

```mermaid
flowchart TD
    Start([Báo cáo Sách]) --> A[Chọn tab "Báo cáo Sách"]
    A --> B[Chọn khoảng thời gian]
    B --> C[Gọi API báo cáo sách]
    C --> D[Hiển thị báo cáo]
    
    D --> E[Bảng: Danh sách sách<br/>- Tên sách<br/>- Thể loại<br/>- Tình trạng<br/>- Số lần mượn<br/>- Số lượng có sẵn]
    
    D --> F[Biểu đồ: Sách theo<br/>thể loại]
    
    D --> G[Biểu đồ: Tình trạng<br/>sách tổng quan]
    
    E --> End([Hiển thị])
    F --> End
    G --> End
```

## Flowchart - Báo cáo Mượn Trả

```mermaid
flowchart TD
    Start([Báo cáo Mượn Trả]) --> A[Chọn tab<br/>"Báo cáo Mượn Trả"]
    A --> B[Chọn khoảng thời gian]
    B --> C[Gọi API báo cáo<br/>mượn trả]
    C --> D[Hiển thị báo cáo]
    
    D --> E[Bảng: Chi tiết<br/>mượn trả<br/>- Ngày<br/>- Số lượt mượn<br/>- Số lượt trả<br/>- Số quá hạn]
    
    D --> F[Biểu đồ đường:<br/>Xu hướng mượn/trả<br/>theo ngày/tháng]
    
    D --> G[Biểu đồ cột:<br/>So sánh mượn/trả<br/>theo thời gian]
    
    E --> End([Hiển thị])
    F --> End
    G --> End
```

## Flowchart - Báo cáo Phạt

```mermaid
flowchart TD
    Start([Báo cáo Phạt]) --> A[Chọn tab<br/>"Báo cáo Phạt"]
    A --> B[Chọn khoảng thời gian]
    B --> C[Gọi API báo cáo phạt]
    C --> D[Hiển thị báo cáo]
    
    D --> E[Số liệu tổng quan:<br/>- Tổng doanh thu phạt<br/>- Số phiếu phạt đã TT<br/>- Số phiếu phạt chưa TT<br/>- Tổng nợ chưa thu]
    
    D --> F[Bảng: Chi tiết phiếu phạt<br/>- Độc giả<br/>- Lý do phạt<br/>- Số tiền<br/>- Trạng thái]
    
    D --> G[Biểu đồ: Phân loại<br/>phạt theo nguyên nhân]
    
    D --> H[Danh sách:<br/>Người nợ quá hạn]
    
    E --> End([Hiển thị])
    F --> End
    G --> End
    H --> End
```

## Flowchart - Báo cáo Sách Mất/Hư

```mermaid
flowchart TD
    Start([Báo cáo Mất/Hư]) --> A[Chọn tab<br/>"Báo cáo Sách Mất/Hư"]
    A --> B[Chọn khoảng thời gian]
    B --> C[Gọi API báo cáo<br/>sách mất/hư]
    C --> D[Hiển thị báo cáo]
    
    D --> E[Số liệu tổng quan:<br/>- Tổng sách mất<br/>- Tổng sách hư hỏng<br/>- Tổng giá trị thiệt hại]
    
    D --> F[Bảng: Danh sách sách<br/>cần thay thế<br/>- Tên sách<br/>- Tình trạng<br/>- Ngày ghi nhận<br/>- Độc giả liên quan]
    
    D --> G[Biểu đồ: Xu hướng<br/>mất/hư theo thời gian]
    
    E --> End([Hiển thị])
    F --> End
    G --> End
```

## Flowchart - Xuất CSV

```mermaid
flowchart TD
    Start([Xuất CSV]) --> A[Click nút<br/>"Xuất CSV"]
    A --> B{Đã chọn<br/>khoảng thời gian?}
    
    B -->|Chưa| C[Hiển thị lỗi:<br/>"Vui lòng chọn<br/>khoảng thời gian"]
    C --> End([Kết thúc])
    
    B -->|Rồi| D[Gọi API xuất CSV<br/>với các filter hiện tại]
    D --> E{API thành công?}
    
    E -->|Lỗi| F[Hiển thị lỗi:<br/>"Không thể xuất báo cáo"]
    F --> End
    
    E -->|Thành công| G[Tạo file CSV]
    G --> H[Trigger download<br/>tự động]
    H --> I[Hiển thị thông báo:<br/>"Xuất báo cáo thành công!"]
    I --> End
```

## Các loại báo cáo

### 1. Báo cáo Sách

| Nội dung | Mô tả |
|----------|-------|
| Tổng số sách | Tổng số đầu sách |
| Theo thể loại | Số sách mỗi thể loại |
| Theo tình trạng | Có sẵn / Đang mượn / Mất / Hư |
| Số lần mượn | Thống kê số lần mượn mỗi sách |

### 2. Báo cáo Mượn Trả

| Nội dung | Mô tả |
|----------|-------|
| Số lượt mượn | Theo ngày / tháng / quý |
| Số lượt trả | Theo ngày / tháng / quý |
| Tỷ lệ trả đúng hạn | % trả đúng hạn |
| Xu hướng | Biểu đồ xu hướng theo thời gian |

### 3. Báo cáo Phạt

| Nội dung | Mô tả |
|----------|-------|
| Tổng doanh thu | Tổng tiền phạt đã thu |
| Phân loại | Theo nguyên nhân (muộn/hư/mất) |
| Nợ chưa thu | Tổng tiền chưa thanh toán |
| Danh sách nợ | Người nợ quá hạn |

### 4. Báo cáo Sách Mất/Hư

| Nội dung | Mô tả |
|----------|-------|
| Số sách mất | Tổng số sách bị mất |
| Số sách hư | Tổng số sách bị hư hỏng |
| Giá trị thiệt hại | Ước tính giá trị |
| Danh sách thay thế | Sách cần mua mới |

## Các khoảng thời gian

| Tùy chọn | Mô tả |
|----------|-------|
| Hôm nay | Ngày hiện tại |
| Tuần này | Từ thứ 2 đến hôm nay |
| Tháng này | Từ ngày 1 đến hôm nay |
| Quý này | Từ đầu quý đến hôm nay |
| Năm này | Từ 1/1 đến hôm nay |
| Tùy chỉnh | Chọn ngày bắt đầu và kết thúc |

## CSV Export Format

### Báo cáo Sách
```csv
STT,Tên sách,Tác giả,Thể loại,Tình trạng,Số lượng,Số lần mượn
1,Đắc Nhân Tâm,Dale Carnegie,Kỹ năng sống,Có sẵn,5,150
```

### Báo cáo Mượn Trả
```csv
STT,Ngày,Số lượt mượn,Số lượt trả,Số quá hạn,Tỷ lệ đúng hạn
1,2024-01-01,25,20,2,90%
```

### Báo cáo Phạt
```csv
STT,Mã phiếu,Độc giả,Email,Lý do,Số tiền,Trạng thái,Ngày phạt
1,F001,Nguyễn Văn A,a@email.com,Trả muộn,50000,Đã thanh toán,2024-01-15
```

## Ghi chú
- Biểu đồ sử dụng thư viện Recharts (theo tech stack)
- File CSV được encode UTF-8 với BOM để hiển thị tiếng Việt đúng trong Excel
- Có thể lọc và sắp xếp dữ liệu trước khi xuất
- Báo cáo được cache để tăng hiệu suất

