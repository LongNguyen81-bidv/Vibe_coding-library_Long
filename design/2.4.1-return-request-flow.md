# 2.4.1 - Luồng Yêu Cầu Trả Sách

## Thông tin chung
- **Mã tính năng:** 2.4.1
- **Actor:** Độc giả (Reader)
- **Yêu cầu:** 
  - Đăng nhập với vai trò Độc giả (2.1.2)
  - Có sách đang mượn (2.3.1)
- **Mục đích:** Cho phép độc giả tạo yêu cầu trả sách

## Flowchart

```mermaid
flowchart TD
    Start([Bắt đầu]) --> A[Độc giả đăng nhập]
    A --> B[Truy cập menu<br/>"Lịch sử mượn sách"]
    B --> C[Xem danh sách<br/>sách đang mượn]
    C --> D{Có sách<br/>đang mượn?}
    
    D -->|Không| E[Hiển thị:<br/>"Bạn không có sách<br/>đang mượn"]
    E --> End([Kết thúc])
    
    D -->|Có| F[Chọn sách muốn trả]
    F --> G[Click "Xin trả sách"]
    G --> H{Đơn mượn này<br/>đã có yêu cầu trả<br/>đang chờ xác nhận?}
    
    H -->|Có| I[Hiển thị lỗi:<br/>"Bạn đã gửi yêu cầu<br/>trả sách này rồi.<br/>Vui lòng chờ xác nhận."]
    I --> End
    
    H -->|Không| J[Hiển thị modal xác nhận:<br/>"Bạn có muốn gửi yêu cầu<br/>trả sách này không?<br/>Vui lòng mang sách đến<br/>thư viện để hoàn tất."]
    J --> K{Người dùng<br/>xác nhận?}
    
    K -->|Hủy| End
    
    K -->|Xác nhận| L[Tạo yêu cầu trả sách:<br/>- Trạng thái: "Chờ xác nhận"<br/>- Ngày yêu cầu: Hôm nay<br/>- borrowingId: ID đơn mượn]
    
    L --> M[Hiển thị thông báo:<br/>"Yêu cầu trả sách<br/>đã được gửi!<br/>Vui lòng mang sách đến<br/>thư viện để hoàn tất."]
    M --> N[Cập nhật UI:<br/>Nút "Xin trả sách"<br/>→ "Đang chờ xác nhận trả"]
    N --> End
```

## Điều kiện tạo yêu cầu trả sách

| STT | Điều kiện | Kiểm tra | Thông báo |
|-----|-----------|----------|-----------|
| 1 | Có sách đang mượn | borrowings với status = BORROWED | "Bạn không có sách đang mượn" |
| 2 | Chưa có yêu cầu trả đang chờ | returnRequests với status = PENDING | "Bạn đã gửi yêu cầu trả sách này rồi" |

## Trạng thái yêu cầu trả sách

| Trạng thái | Mô tả |
|------------|-------|
| Chờ xác nhận | Độc giả đã tạo yêu cầu, chờ nhân viên xác nhận |
| Đã xác nhận | Nhân viên đã xác nhận trả sách |
| Đã hủy | Yêu cầu bị hủy |

## Dữ liệu yêu cầu trả sách

```json
{
  "id": "uuid",
  "borrowingId": "uuid",
  "readerId": "uuid",
  "bookId": "uuid",
  "requestDate": "2024-01-15",
  "status": "PENDING",
  "createdAt": "2024-01-15T10:00:00Z"
}
```

## Quy tắc nghiệp vụ

1. **Một đơn mượn - một yêu cầu trả:** Mỗi đơn mượn chỉ có thể có một yêu cầu trả ở trạng thái "Chờ xác nhận" tại một thời điểm
2. **Không tự động trả:** Yêu cầu trả sách chỉ là thông báo cho nhân viên, sách vẫn chưa được trả cho đến khi nhân viên xác nhận
3. **Mang sách đến thư viện:** Độc giả cần mang sách vật lý đến thư viện để nhân viên kiểm tra và xác nhận

## Hiển thị trên UI

### Trước khi tạo yêu cầu
- Nút: "Xin trả sách" (màu xanh)

### Sau khi tạo yêu cầu
- Nút: "Đang chờ xác nhận trả" (màu xám, disabled)
- Hoặc: Badge "Đang chờ trả" trên dòng đơn mượn

## Ghi chú
- Độc giả có thể tạo nhiều yêu cầu trả cho nhiều sách khác nhau
- Yêu cầu trả không tự động giảm số sách đang mượn (chỉ giảm khi nhân viên xác nhận)
- Nếu độc giả không đến thư viện sau một thời gian, nhân viên có thể hủy yêu cầu

