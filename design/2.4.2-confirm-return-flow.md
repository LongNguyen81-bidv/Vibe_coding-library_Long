# 2.4.2 - Luồng Xác Nhận Trả Sách

## Thông tin chung
- **Mã tính năng:** 2.4.2
- **Actor:** Nhân viên thư viện (Librarian)
- **Yêu cầu:** 
  - Đăng nhập với vai trò Nhân viên thư viện (2.1.2)
  - Có yêu cầu trả sách chờ xác nhận (2.4.1)
- **Mục đích:** Xác nhận trả sách và đánh giá tình trạng sách

## Flowchart - Tổng quan

```mermaid
flowchart TD
    Start([Bắt đầu]) --> A[Nhân viên đăng nhập]
    A --> B[Truy cập menu<br/>"Quản lý mượn trả"]
    B --> C[Tab "Chờ xác nhận trả"]
    C --> D[Hiển thị danh sách<br/>yêu cầu trả sách]
    
    D --> E{Có yêu cầu<br/>chờ xác nhận?}
    E -->|Không| F[Hiển thị:<br/>"Không có yêu cầu<br/>trả sách nào"]
    F --> End([Kết thúc])
    
    E -->|Có| G[Chọn yêu cầu<br/>cần xử lý]
    G --> H[Nhận sách vật lý<br/>từ độc giả]
    H --> I[Click "Xác nhận trả"]
    I --> J[Hiển thị modal<br/>kiểm tra tình trạng sách]
    J --> K{Chọn tình trạng<br/>sách}
    
    K -->|Bình thường| L[Luồng Trả Bình thường]
    K -->|Hư hỏng| M[Luồng Sách Hư hỏng]
    K -->|Mất| N[Luồng Sách Mất]
    
    L --> D
    M --> D
    N --> D
```

## Flowchart - Trả sách bình thường

```mermaid
flowchart TD
    Start([Sách bình thường]) --> A[Chọn "Bình thường"]
    A --> B{Kiểm tra<br/>sách có trả muộn?}
    
    B -->|Không - Đúng hạn| C[Xác nhận trả]
    C --> D[Cập nhật database:<br/>- Đơn mượn: "Đã trả"<br/>- returnDate = Hôm nay<br/>- Sách: availableQuantity + 1<br/>- Sách: borrowedQuantity - 1]
    D --> E[Hiển thị thông báo:<br/>"Xác nhận trả sách<br/>thành công!"]
    E --> End([Kết thúc])
    
    B -->|Có - Quá hạn| F[Hiển thị cảnh báo:<br/>"Sách trả muộn X ngày"]
    F --> G[Chọn mức phạt<br/>trả muộn từ dropdown]
    G --> H[Xác nhận trả + Tạo phiếu phạt]
    H --> I[Cập nhật database:<br/>- Đơn mượn: "Đã trả"<br/>- returnDate = Hôm nay<br/>- Sách: availableQuantity + 1<br/>- Sách: borrowedQuantity - 1<br/>- Tạo phiếu phạt "Trả muộn"]
    I --> J[Hiển thị thông báo:<br/>"Xác nhận trả sách thành công!<br/>Đã tạo phiếu phạt trả muộn."]
    J --> End
```

## Flowchart - Sách hư hỏng

```mermaid
flowchart TD
    Start([Sách hư hỏng]) --> A[Chọn "Hư hỏng"]
    A --> B[Chọn mức phạt<br/>hư hỏng từ dropdown]
    B --> C[Nhập ghi chú<br/>mô tả tình trạng hư hỏng]
    C --> D{Ghi chú đã nhập?}
    
    D -->|Không/Trống| E[Hiển thị lỗi:<br/>"Vui lòng nhập ghi chú<br/>mô tả tình trạng hư hỏng"]
    E --> C
    
    D -->|Có| F{Kiểm tra<br/>sách có trả muộn?}
    
    F -->|Không| G[Tạo 1 phiếu phạt:<br/>- Phạt hư hỏng]
    F -->|Có| H[Tạo 2 phiếu phạt:<br/>- Phạt hư hỏng<br/>- Phạt trả muộn]
    
    G --> I[Cập nhật database:<br/>- Đơn mượn: "Đã trả"<br/>- Sách: availableQuantity + 1<br/>- Sách: borrowedQuantity - 1<br/>- Tạo phiếu phạt]
    H --> I
    
    I --> J[Hiển thị thông báo:<br/>"Xác nhận trả sách thành công!<br/>Đã tạo phiếu phạt."]
    J --> End([Kết thúc])
```

## Flowchart - Sách mất

```mermaid
flowchart TD
    Start([Sách mất]) --> A[Chọn "Mất"]
    A --> B[Chọn mức phạt<br/>mất sách từ dropdown]
    B --> C[Nhập ghi chú<br/>về việc mất sách]
    C --> D{Ghi chú đã nhập?}
    
    D -->|Không/Trống| E[Hiển thị lỗi:<br/>"Vui lòng nhập ghi chú"]
    E --> C
    
    D -->|Có| F[Cập nhật database:<br/>- Đơn mượn: "Đã trả"<br/>- bookCondition = "LOST"<br/>- Sách: borrowedQuantity - 1<br/>- KHÔNG tăng availableQuantity<br/>- Tạo phiếu phạt "Mất sách"]
    
    F --> G[Hiển thị thông báo:<br/>"Đã ghi nhận sách mất.<br/>Phiếu phạt đã được tạo."]
    G --> End([Kết thúc])
```

## Thông tin hiển thị

| Trường | Mô tả |
|--------|-------|
| Mã yêu cầu | ID yêu cầu trả |
| Tên độc giả | Người trả sách |
| Tên sách | Sách được trả |
| Ngày mượn | Ngày bắt đầu mượn |
| Hạn trả | Ngày phải trả |
| Ngày yêu cầu | Ngày tạo yêu cầu trả |
| Trạng thái | Đúng hạn / Quá hạn X ngày |

## Các tình trạng sách

| Tình trạng | Mã | Phạt | Cập nhật số lượng |
|------------|-----|------|-------------------|
| Bình thường | NORMAL | Chỉ phạt nếu trả muộn | availableQuantity + 1 |
| Hư hỏng | DAMAGED | Phạt hư hỏng (+ trả muộn nếu có) | availableQuantity + 1 |
| Mất | LOST | Phạt mất sách | Không tăng availableQuantity |

## Validation Rules

| Trường | Quy tắc | Thông báo lỗi |
|--------|---------|---------------|
| Tình trạng sách | Bắt buộc chọn | "Vui lòng chọn tình trạng sách" |
| Mức phạt | Bắt buộc khi hư hỏng/mất/trả muộn | "Vui lòng chọn mức phạt" |
| Ghi chú | Bắt buộc khi hư hỏng/mất | "Vui lòng nhập ghi chú" |
| Ghi chú | Tối đa 500 ký tự | "Ghi chú không được vượt quá 500 ký tự" |

## Cập nhật dữ liệu khi xác nhận trả

| Trường hợp | Đơn mượn | Sách | Phiếu phạt |
|------------|----------|------|------------|
| Bình thường + Đúng hạn | status = RETURNED | available + 1, borrowed - 1 | Không |
| Bình thường + Quá hạn | status = RETURNED | available + 1, borrowed - 1 | 1 (trả muộn) |
| Hư hỏng + Đúng hạn | status = RETURNED, condition = DAMAGED | available + 1, borrowed - 1 | 1 (hư hỏng) |
| Hư hỏng + Quá hạn | status = RETURNED, condition = DAMAGED | available + 1, borrowed - 1 | 2 (hư hỏng + trả muộn) |
| Mất | status = RETURNED, condition = LOST | borrowed - 1 (không + available) | 1 (mất sách) |

## Ghi chú
- Mức phạt được lấy từ danh sách mức phạt đã cấu hình (2.5.1)
- Sách mất không được thêm lại vào kho (availableQuantity không tăng)
- Có thể tạo nhiều phiếu phạt cho một lần trả sách (hư hỏng + trả muộn)
- Ghi chú giúp lưu lại thông tin chi tiết về tình trạng sách

