# 2.5.1 - Luồng Quản Lý Mức Phạt

## Thông tin chung
- **Mã tính năng:** 2.5.1
- **Actor:** Quản lý viên (Admin)
- **Yêu cầu:** Đăng nhập với vai trò Quản lý viên (2.1.2)
- **Mục đích:** Quản lý các mức phạt áp dụng trong hệ thống

## Flowchart - Tổng quan

```mermaid
flowchart TD
    Start([Bắt đầu]) --> A[Admin đăng nhập]
    A --> B[Truy cập menu<br/>"Quản lý mức phạt"]
    B --> C[Hiển thị bảng danh sách<br/>các mức phạt]
    
    C --> D{Admin muốn<br/>làm gì?}
    
    D -->|Thêm mới| E[Luồng Thêm mức phạt]
    D -->|Sửa| F[Luồng Sửa mức phạt]
    D -->|Xóa| G[Luồng Xóa mức phạt]
    D -->|Không làm gì| End([Kết thúc])
    
    E --> C
    F --> C
    G --> C
```

## Flowchart - Thêm mức phạt

```mermaid
flowchart TD
    Start([Thêm mức phạt]) --> A[Click "Thêm mức phạt"]
    A --> B[Hiển thị form/modal<br/>thêm mới]
    B --> C[Nhập thông tin:<br/>- Tên mức phạt<br/>- Số tiền phạt<br/>- Mô tả]
    C --> D[Click "Lưu"]
    D --> E{Validate dữ liệu}
    
    E -->|Tên trống| F[Lỗi: Tên mức phạt<br/>không được để trống]
    E -->|Tên > 25 ký tự| G[Lỗi: Tên không được<br/>vượt quá 25 ký tự]
    E -->|Số tiền <= 0| H[Lỗi: Số tiền phạt<br/>phải lớn hơn 0]
    E -->|Số tiền không phải số| I[Lỗi: Số tiền phạt<br/>phải là số]
    
    F --> C
    G --> C
    H --> C
    I --> C
    
    E -->|Hợp lệ| J{Tên mức phạt<br/>đã tồn tại?}
    
    J -->|Có| K[Lỗi: Mức phạt này<br/>đã tồn tại]
    K --> C
    
    J -->|Không| L[Lưu vào database:<br/>- Tên mức phạt<br/>- Số tiền<br/>- Ngày tạo = Hôm nay]
    L --> M[Hiển thị thông báo:<br/>"Thêm mức phạt thành công!"]
    M --> N[Cập nhật bảng<br/>danh sách]
    N --> End([Kết thúc])
```

## Flowchart - Sửa mức phạt

```mermaid
flowchart TD
    Start([Sửa mức phạt]) --> A[Click vào ô trên bảng<br/>để sửa trực tiếp]
    A --> B[Ô chuyển thành<br/>input có thể chỉnh sửa]
    B --> C[Nhập giá trị mới]
    C --> D[Nhấn Enter hoặc<br/>click ra ngoài để lưu]
    D --> E{Validate dữ liệu}
    
    E -->|Tên trống| F[Lỗi: Tên không được<br/>để trống]
    E -->|Tên > 25 ký tự| G[Lỗi: Tên không được<br/>vượt quá 25 ký tự]
    E -->|Số tiền <= 0| H[Lỗi: Số tiền phải<br/>lớn hơn 0]
    
    F --> C
    G --> C
    H --> C
    
    E -->|Hợp lệ| I{Tên trùng với<br/>mức phạt khác?}
    
    I -->|Có| J[Lỗi: Mức phạt này<br/>đã tồn tại]
    J --> C
    
    I -->|Không| K[Cập nhật database]
    K --> L[Hiển thị thông báo:<br/>"Cập nhật thành công!"]
    L --> End([Kết thúc])
```

## Flowchart - Xóa mức phạt

```mermaid
flowchart TD
    Start([Xóa mức phạt]) --> A[Click nút "Xóa"<br/>trên dòng mức phạt]
    A --> B{Mức phạt này<br/>đang được sử dụng<br/>trong phiếu phạt?}
    
    B -->|Có| C[Hiển thị lỗi:<br/>"Không thể xóa mức phạt<br/>đang được sử dụng"]
    C --> End([Kết thúc])
    
    B -->|Không| D[Hiển thị modal xác nhận:<br/>"Bạn có chắc muốn xóa<br/>mức phạt này?"]
    D --> E{Người dùng<br/>xác nhận?}
    
    E -->|Hủy| End
    E -->|Xác nhận| F[Xóa khỏi database]
    F --> G[Hiển thị thông báo:<br/>"Xóa mức phạt thành công!"]
    G --> H[Cập nhật bảng<br/>danh sách]
    H --> End
```

## Thông tin mức phạt

| Trường | Bắt buộc | Mô tả |
|--------|----------|-------|
| Tên mức phạt | ✅ | Tên định danh mức phạt |
| Số tiền | ✅ | Số tiền phạt (VNĐ) |
| Mô tả | ❌ | Mô tả chi tiết (tùy chọn) |
| Ngày tạo | Tự động | Ngày tạo mức phạt |

## Validation Rules

| Trường | Quy tắc | Thông báo lỗi |
|--------|---------|---------------|
| Tên mức phạt | Không được trống | "Tên mức phạt không được để trống" |
| Tên mức phạt | Tối đa 25 ký tự | "Tên không được vượt quá 25 ký tự" |
| Tên mức phạt | Unique | "Mức phạt này đã tồn tại" |
| Số tiền | > 0 | "Số tiền phạt phải lớn hơn 0" |
| Số tiền | Kiểu số | "Số tiền phạt phải là số" |

## Ví dụ các mức phạt

| Tên mức phạt | Số tiền (VNĐ) | Mô tả |
|--------------|---------------|-------|
| Trả muộn 1-7 ngày | 10,000 | Phạt trả sách muộn từ 1-7 ngày |
| Trả muộn 8-14 ngày | 20,000 | Phạt trả sách muộn từ 8-14 ngày |
| Trả muộn > 14 ngày | 50,000 | Phạt trả sách muộn trên 14 ngày |
| Hư hỏng nhẹ | 30,000 | Sách bị hư hỏng nhẹ |
| Hư hỏng nặng | 100,000 | Sách bị hư hỏng nghiêm trọng |
| Mất sách | 200,000 | Mất sách, cần đền bù |

## Điều kiện xóa mức phạt

| Điều kiện | Cho phép xóa | Thông báo |
|-----------|--------------|-----------|
| Không có phiếu phạt sử dụng | ✅ | - |
| Có phiếu phạt đang sử dụng | ❌ | "Không thể xóa mức phạt đang được sử dụng" |

## Ghi chú
- Mức phạt được sử dụng khi xác nhận trả sách (2.4.2)
- Sửa trực tiếp trên bảng (inline editing) để tăng trải nghiệm
- Không thể xóa mức phạt đang được tham chiếu trong phiếu phạt
- Số tiền phạt có thể được format hiển thị với dấu phẩy (1,000,000 VNĐ)

