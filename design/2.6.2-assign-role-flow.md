# 2.6.2 - Luồng Gán Vai Trò

## Thông tin chung
- **Mã tính năng:** 2.6.2
- **Actor:** Quản lý viên (Admin)
- **Yêu cầu:** 
  - Đăng nhập với vai trò Quản lý viên (2.1.2)
  - Có danh sách người dùng (2.6.1)
- **Mục đích:** Thay đổi vai trò của người dùng trong hệ thống

## Flowchart

```mermaid
flowchart TD
    Start([Bắt đầu]) --> A[Admin đăng nhập]
    A --> B[Truy cập menu<br/>"Quản lý người dùng"]
    B --> C[Xem danh sách<br/>người dùng]
    C --> D[Chọn người dùng<br/>cần thay đổi vai trò]
    D --> E[Click "Gán vai trò"<br/>hoặc click vào ô Vai trò]
    E --> F[Hiển thị dropdown<br/>chọn vai trò mới]
    
    F --> G[Hiển thị các tùy chọn:<br/>- Reader<br/>- Librarian<br/>- Admin]
    G --> H{Chọn vai trò mới}
    
    H -->|Vai trò cũ| I[Không làm gì<br/>Đóng dropdown]
    I --> End([Kết thúc])
    
    H -->|Vai trò mới| J{Vai trò mới<br/>là gì?}
    
    J -->|Reader hoặc<br/>Librarian| K[Hiển thị modal:<br/>"Bạn có chắc muốn<br/>thay đổi vai trò<br/>thành [vai trò mới]?"]
    
    J -->|Admin| L{Người dùng này<br/>là Admin cuối cùng<br/>đang hạ cấp?}
    
    L -->|Có| M[Hiển thị lỗi:<br/>"Không thể hạ cấp<br/>Admin cuối cùng"]
    M --> End
    
    L -->|Không| K
    
    K --> N{Admin<br/>xác nhận?}
    
    N -->|Hủy| End
    
    N -->|Xác nhận| O[Cập nhật database:<br/>role = vai trò mới]
    O --> P[Hiển thị thông báo:<br/>"Thay đổi vai trò<br/>thành công!"]
    P --> Q[Cập nhật UI:<br/>Hiển thị vai trò mới]
    Q --> End
```

## Flowchart - Gán vai trò Admin

```mermaid
flowchart TD
    Start([Gán Admin]) --> A{Người dùng hiện tại<br/>ở vai trò gì?}
    
    A -->|Reader| B[Hiển thị cảnh báo:<br/>"Nâng cấp lên Admin<br/>sẽ cho phép toàn quyền<br/>quản lý hệ thống"]
    A -->|Librarian| B
    A -->|Admin| C[Không làm gì<br/>Đã là Admin]
    C --> End([Kết thúc])
    
    B --> D[Admin xác nhận]
    D --> E{Xác nhận?}
    
    E -->|Hủy| End
    E -->|Xác nhận| F[Cập nhật:<br/>role = "ADMIN"]
    F --> G[Hiển thị thông báo:<br/>"Đã nâng cấp lên Admin!"]
    G --> End
```

## Flowchart - Hạ cấp từ Admin

```mermaid
flowchart TD
    Start([Hạ cấp Admin]) --> A{Đếm số Admin<br/>trong hệ thống}
    
    A -->|Chỉ còn 1| B[Hiển thị lỗi:<br/>"Không thể hạ cấp<br/>Admin cuối cùng.<br/>Hệ thống cần ít nhất<br/>1 Admin."]
    B --> End([Kết thúc])
    
    A -->|Nhiều hơn 1| C[Hiển thị cảnh báo:<br/>"Hạ cấp từ Admin sẽ<br/>thu hồi quyền quản lý<br/>hệ thống"]
    C --> D{Admin xác nhận?}
    
    D -->|Hủy| End
    D -->|Xác nhận| E[Cập nhật:<br/>role = vai trò mới]
    E --> F[Hiển thị thông báo:<br/>"Đã thay đổi vai trò!"]
    F --> End
```

## Các vai trò trong hệ thống

| Vai trò | Mã | Quyền hạn |
|---------|-----|-----------|
| Reader | READER | Mượn sách, xem lịch sử, thanh toán phạt, quản lý hồ sơ |
| Librarian | LIBRARIAN | Tất cả quyền Reader + Quản lý sách, xác nhận mượn/trả, quản lý phạt |
| Admin | ADMIN | Tất cả quyền Librarian + Quản lý người dùng, gán vai trò, báo cáo thống kê |

## Ma trận chuyển đổi vai trò

| Từ \ Đến | Reader | Librarian | Admin |
|----------|--------|-----------|-------|
| Reader | - | ✅ | ✅ |
| Librarian | ✅ | - | ✅ |
| Admin | ✅* | ✅* | - |

*Không thể hạ cấp nếu là Admin cuối cùng

## Validation Rules

| Quy tắc | Điều kiện | Thông báo lỗi |
|---------|-----------|---------------|
| Không hạ cấp Admin cuối cùng | adminCount > 1 | "Không thể hạ cấp Admin cuối cùng" |
| Vai trò hợp lệ | role in [READER, LIBRARIAN, ADMIN] | "Vai trò không hợp lệ" |
| Tài khoản đã kích hoạt | status = ACTIVE | "Không thể gán vai trò cho tài khoản chưa kích hoạt" |

## Cập nhật sau khi thay đổi vai trò

| Thay đổi | Hiệu lực |
|----------|----------|
| Reader → Librarian | Ngay lập tức, cần refresh trang |
| Reader → Admin | Ngay lập tức, cần refresh trang |
| Librarian → Reader | Ngay lập tức, mất quyền quản lý |
| Librarian → Admin | Ngay lập tức, thêm quyền quản lý |
| Admin → Librarian | Ngay lập tức, mất quyền admin |
| Admin → Reader | Ngay lập tức, mất quyền admin & librarian |

## Ghi chú
- Sau khi thay đổi vai trò, người dùng cần refresh trang để thấy menu mới
- JWT token sẽ được cập nhật với vai trò mới ở lần đăng nhập tiếp theo
- Hệ thống luôn phải có ít nhất 1 Admin
- Chỉ Admin mới có quyền gán vai trò cho người khác
- Admin không thể tự hạ cấp chính mình nếu là Admin cuối cùng

